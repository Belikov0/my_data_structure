#include <iostream>
#include <deque>
#include <vector>

using namespace std;
int ans;
int c, u, v, w;
void read(int& x){
    char ch = getchar();
    x = 0;
    for (; ch < '0' || ch > '9'; ch = getchar());

    for (; ch >= '0' && ch <='9'; ch = getchar())
        x = x*10 + ch - '0';
}

int main(){
    int N, Q;
    vector<deque<int> > deq(150005);
    while(~scanf("%d%d", &N, &Q)){
        for (int i = 0; i < Q; i++){
            deq[i].clear();
        }

        while(Q--){
            read(c); read(u);
            switch (c) {
                case 1 :
                    int val;
                    read(w);read(val);
                    if (w == 0)
                        deq[u].push_front(val);
                    else
                        deq[u].push_back(val);
                    break;
                case 2 :
                    read(w);
                    if (deq[u].empty()){
                        cout << -1 << endl;
                    }else{
                        if (w == 0) {
                            cout << deq[u].front() << endl;
                            deq[u].pop_front();
                        } else {
                            cout << deq[u].back() << endl;
                            deq[u].pop_back();
                        }
                    }
                    break;
                case 3 :
                    read(v);read(w);
                    if (w == 0){
                        deq[u].insert(deq[u].end(), deq[v].begin(), deq[v].end());
                    }
                    else{
                        deq[u].insert(deq[u].end(), deq[v].rbegin(), deq[v].rend());
                    }
                    deq[v].clear();
                    break;
            }

        }
    }

    return 0;
}